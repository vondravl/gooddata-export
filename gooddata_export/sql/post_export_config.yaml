# Post-Export SQL Configuration
#
# This file defines all SQL operations that run after metadata export.
# Operations are executed in dependency order using topological sort.
#
# Structure:
#   - tables: New tables created via SQL (some may need Python populate step)
#   - views: Read-only database views (SELECT)
#   - updates: Table modifications (ALTER TABLE, UPDATE)
#   - procedures: Parameterized procedures (SQLite stored procedure simulation)
#
# Each entry contains:
#   - sql_file: Path to SQL file (relative to sql/ directory)
#   - description: Human-readable purpose
#   - category: Grouping for documentation (tagging/usage/analytics/deduplication/procedures)
#   - dependencies: List of other views/updates this depends on
#   - table: (updates only) Which table this modifies
#   - required_columns: (updates only) Columns to ensure exist before running
#   - parameters: (procedures only) Variables to substitute in the procedure
#   - python_populate: (tables only) Python function to call after table creation

# ====================
# TABLES (Created Tables)
# ====================
# Tables that need to be created for derived data.
# Some tables need Python populate step (e.g., regex extraction).
tables:
  metrics_relationships:
    sql_file: tables/metrics_relationships.sql
    description: Direct metric-to-metric references extracted from MAQL formulas
    category: usage
    dependencies: []
    python_populate: populate_metrics_relationships  # Requires Python regex extraction

  metrics_ancestry:
    sql_file: tables/metrics_ancestry.sql
    description: Full transitive metric ancestry using recursive CTE
    category: usage
    dependencies:
      - metrics_relationships  # Must be populated first

# ====================
# VIEWS (Read-Only)
# ====================
views:
  # Tag Views - Simple entity-specific views that unnest tags
  v_metrics_tags:
    sql_file: views/v_metrics_tags.sql
    description: Unnests metric tags into individual rows
    category: tagging
    dependencies: []
  
  v_visualizations_tags:
    sql_file: views/v_visualizations_tags.sql
    description: Unnests visualization tags into individual rows (used by duplicate detection)
    category: tagging
    dependencies: []

  v_dashboards_tags:
    sql_file: views/v_dashboards_tags.sql
    description: Unnests dashboard tags into individual rows
    category: tagging
    dependencies: []
  
  # Usage Views - Combined views joining multiple tables
  v_metrics_usage:
    sql_file: views/v_metrics_usage.sql
    description: Shows where metrics are used across dashboards and visualizations
    category: usage
    dependencies: []

  # Metric Relationship Views - Based on metrics_relationships and metrics_ancestry tables
  v_metrics_relationships:
    sql_file: views/v_metrics_relationships.sql
    description: Direct metric-to-metric relationships with titles and reference status
    category: usage
    dependencies:
      - metrics_relationships

  v_metrics_relationships_ancestry:
    sql_file: views/v_metrics_relationships_ancestry.sql
    description: Full metric ancestry with titles and tags
    category: usage
    dependencies:
      - metrics_ancestry

  v_metrics_relationships_root:
    sql_file: views/v_metrics_relationships_root.sql
    description: Root metrics that don't depend on other metrics
    category: usage
    dependencies:
      - metrics_relationships

  v_visualizations_usage:
    sql_file: views/v_visualizations_usage.sql
    description: Shows where visualizations are used in dashboards
    category: usage
    dependencies: []

  v_filter_contexts_usage:
    sql_file: views/v_filter_contexts_usage.sql
    description: Shows where filter contexts are used in dashboards
    category: usage
    dependencies: []

  # Data Model Views - LDM-specific tag views
  v_ldm_datasets_tags:
    sql_file: views/v_ldm_datasets_tags.sql
    description: Unnests LDM dataset tags into individual rows
    category: tagging
    dependencies: []
  
  v_ldm_columns_tags:
    sql_file: views/v_ldm_columns_tags.sql
    description: Unnests LDM column tags into individual rows
    category: tagging
    dependencies: []
  
  v_ldm_dataset_column_tag_check:
    sql_file: views/v_ldm_dataset_column_tag_check.sql
    description: Validates that dataset columns have matching tags with their parent dataset
    category: validation
    dependencies: []

# ====================
# PROCEDURES (Parameterized)
# ====================
# SQLite doesn't support stored procedures, so we simulate them with parameterized views.
# Parameters are substituted at execution time from ExportConfig and environment.
procedures:
  v_api_automation_metrics:
    sql_file: procedures/v_api_automation_metrics.sql
    description: Procedure to generate API curl commands for metric operations
    category: procedures
    dependencies: []
    parameters:
      base_url: "{{BASE_URL}}"  # Will be replaced with actual base_url from config
      workspace_id: "{{WORKSPACE_ID}}"  # Will be replaced with actual workspace_id from config
      bearer_token: "$${TOKEN_GOODDATA_DEV}"  # Will be replaced with literal ${TOKEN_GOODDATA_DEV} for shell
  
  v_api_automation_workspaces:
    sql_file: procedures/v_api_automation_workspaces.sql
    description: Procedure to generate API curl commands for workspace operations
    category: procedures
    dependencies: []
    parameters:
      base_url: "{{BASE_URL}}"  # Will be replaced with actual base_url from config
      bearer_token: "$${TOKEN_GOODDATA_DEV}"  # Will be replaced with literal ${TOKEN_GOODDATA_DEV} for shell

# ====================
# TABLE UPDATES
# ====================
updates:
  # Visualization Updates
  visuals_with_same_content:
    sql_file: updates/visuals_with_same_content.sql
    description: Identifies duplicate visualizations based on content and tags
    category: deduplication
    table: visualizations
    dependencies:
      - v_visualizations_tags  # Uses this view for tag comparison
    required_columns:
      columns: TEXT
      same_columns_id: INTEGER
      same_visuals_id: INTEGER
      same_visuals_id_with_tags: INTEGER
  
  visualizations_usage_check:
    sql_file: updates/visualizations_usage_check.sql
    description: Marks visualizations as used/unused based on dashboard presence
    category: usage
    table: visualizations
    dependencies: []
    required_columns:
      is_used: INTEGER DEFAULT 0
  
  # Metric Updates
  metrics_probable_duplicates:
    sql_file: updates/metrics_probable_duplicates.sql
    description: Identifies probable duplicate metrics based on MAQL, title, and ID patterns
    category: deduplication
    table: metrics
    dependencies: []
    required_columns:
      similar_metric_id: INTEGER
  
  metrics_usage_check:
    sql_file: updates/metrics_usage_check.sql
    description: Marks metrics as used in insights or MAQL formulas
    category: usage
    table: metrics
    dependencies:
      - metrics_relationships  # is_used_maql uses this table
    required_columns:
      is_used_insight: INTEGER DEFAULT 0
      is_used_maql: INTEGER DEFAULT 0
  
  # Filter Context Updates
  filter_contexts_with_same_content:
    sql_file: updates/filter_contexts_with_same_content.sql
    description: Identifies duplicate filter contexts based on filter fields
    category: deduplication
    table: filter_contexts
    dependencies: []
    required_columns:
      filter_fields: TEXT
      same_fields_id: INTEGER
      same_filter_contexts_count: INTEGER
  
  filter_contexts_usage_check:
    sql_file: updates/filter_contexts_usage_check.sql
    description: Marks filter contexts as used/unused based on dashboard references
    category: usage
    table: filter_contexts
    dependencies: []
    required_columns:
      is_used: INTEGER DEFAULT 0

